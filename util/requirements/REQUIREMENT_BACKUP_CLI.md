# Requirement: Parallels VM Backup CLI Tool

## Overview
Create a CLI tool for macOS to backup and restore Parallels Desktop VM (.pvm bundle) to Azure Blob Storage using rclone. The tool syncs existing VM snapshots (no snapshot creation needed).

## Target Platform
- **Host OS**: macOS (the Mac running Parallels Desktop)
- **Tool location**: Install to `~/bin/`

## Azure Resources (Already Provisioned)

| Resource | Value |
|----------|-------|
| Subscription ID | `cbe9549c-96e8-4547-a2ba-667a5f13e5ff` |
| Resource Group | `rg-local-dev-backup` |
| Storage Account | `stlocaldevbackupppozdl5m` |
| Container Name | `parallels-vm` |
| Blob Endpoint | `https://stlocaldevbackupppozdl5m.blob.core.windows.net/` |

## CLI Commands Required

```bash
# Push (backup) VM to Azure - sync existing .pvm to blob
backup_cli push [--vm-name <name>] [--dry-run]

# Pull (restore) VM from Azure - download to restore location (default: ~/)
backup_cli pull [--vm-name <name>] [--dry-run] [--dest <path>]

# Show status/diff between local and remote
backup_cli status [--vm-name <name>]

# List available backups in Azure
backup_cli list

# Show current configuration
backup_cli config

# Initialize/setup - configure rclone and create config
backup_cli init

# Show help for any command
backup_cli help [command]
```

## Authentication: Azure CLI (Recommended - No SAS Token Needed)

Use Azure CLI authentication via `env_auth` - simplest for personal use:
1. User runs `az login` once on their Mac
2. rclone uses those credentials automatically
3. No SAS token management needed

Reference: https://rclone.org/azureblob/#authentication

### rclone Configuration (auto-generated by tool)

```ini
[azure-backup]
type = azureblob
account = stlocaldevbackupppozdl5m
env_auth = true
```

## Configuration File

Location: `~/.config/backup_cli/config.yaml`

The tool should also generate `~/.config/backup_cli/config.example.yaml` as documentation.

### config.example.yaml (generate this as reference)

```yaml
# =============================================================================
# Parallels VM Backup CLI Configuration
# =============================================================================
# Copy this file to config.yaml and customize as needed.
# All paths support ~ for home directory expansion.
# =============================================================================

# -----------------------------------------------------------------------------
# Azure Blob Storage Configuration
# -----------------------------------------------------------------------------
azure:
  # Storage account name (do not change unless using different storage)
  storage_account: stlocaldevbackupppozdl5m

  # Container name for VM backups
  container: parallels-vm

  # rclone remote name (configured automatically by 'backup_cli init')
  rclone_remote: azure-backup

# -----------------------------------------------------------------------------
# Parallels VM Configuration
# -----------------------------------------------------------------------------
parallels:
  # Default VM name to backup (used when --vm-name not specified)
  # Run 'prlctl list -a' to see available VMs
  vm_name: Ubuntu

  # Path to Parallels VMs directory
  # Default: ~/Parallels
  vm_dir: ~/Parallels

# -----------------------------------------------------------------------------
# Restore Configuration
# -----------------------------------------------------------------------------
restore:
  # Default destination for pulled/restored VMs
  # IMPORTANT: Pull does NOT overwrite the original VM location by default
  # It downloads to this directory instead for safety
  # Default: ~/ParallelsRestore
  dest_dir: ~/ParallelsRestore

# -----------------------------------------------------------------------------
# Sync Options
# -----------------------------------------------------------------------------
options:
  # Suspend VM before push for data consistency (recommended)
  suspend_before_push: true

  # Resume VM after push completes
  resume_after_push: true

  # Number of parallel file transfers (1-16)
  transfers: 4

  # Number of parallel checkers for comparing files (1-16)
  checkers: 8

  # Bandwidth limit for transfers (empty = unlimited)
  # Examples: "10M" = 10 MB/s, "1G" = 1 GB/s, "" = unlimited
  bandwidth_limit: ""
```

## Implementation Requirements

### 1. Prerequisites Check & Help Commands

The tool must check prerequisites and provide helpful commands when something is missing:

```bash
# If rclone not installed:
echo "ERROR: rclone is not installed"
echo "To install, run:"
echo "  brew install rclone"

# If Azure CLI not installed:
echo "ERROR: Azure CLI is not installed"
echo "To install, run:"
echo "  brew install azure-cli"

# If not logged into Azure:
echo "ERROR: Not logged into Azure"
echo "To login, run:"
echo "  az login"

# If rclone cannot reach Azure blob:
echo "ERROR: Cannot connect to Azure Blob Storage"
echo "Please check:"
echo "  1. You are logged into Azure: az login"
echo "  2. You have access to subscription: az account set --subscription cbe9549c-96e8-4547-a2ba-667a5f13e5ff"
echo "  3. Run 'backup_cli init' to reconfigure"
```

### 2. Init Command Logic

```
1. Check rclone installed → if not, print install command and exit
2. Check Azure CLI installed → if not, print install command and exit
3. Check Azure login status (az account show) → if not logged in, print az login and exit
4. Set correct subscription: az account set --subscription cbe9549c-96e8-4547-a2ba-667a5f13e5ff
5. Configure rclone remote programmatically:
   rclone config create azure-backup azureblob account=stlocaldevbackupppozdl5m env_auth=true
6. Test connection: rclone lsd azure-backup:parallels-vm
7. If test fails, show troubleshooting steps
8. Detect Parallels VMs: prlctl list -a
9. Create config.yaml with detected VM name
10. Create config.example.yaml as documentation
11. Print success message with next steps
```

### 3. Push Command Logic

```
1. Load config, check prerequisites
2. Sanity check: test rclone can reach Azure (rclone lsd azure-backup:)
3. Check VM exists at configured path
4. If suspend_before_push enabled AND VM is running:
   prlctl suspend "<vm_name>"
5. Run sync:
   rclone sync ~/Parallels/<vm>.pvm azure-backup:parallels-vm/<vm>.pvm \
     --progress --transfers 4 --checkers 8
6. If resume_after_push enabled:
   prlctl resume "<vm_name>"
7. Show summary (files synced, size, duration)
```

### 4. Pull Command Logic (IMPORTANT: Safe by default)

```
1. Load config, check prerequisites
2. Sanity check: test rclone can reach Azure
3. Determine destination:
   - Default: ~/ParallelsRestore/<vm>.pvm (from config restore.dest_dir)
   - Override: --dest <path> flag
4. NEVER overwrite ~/Parallels/<vm>.pvm directly (safety)
5. If destination exists, warn and ask for confirmation
6. Run sync:
   rclone sync azure-backup:parallels-vm/<vm>.pvm <dest>/<vm>.pvm --progress
7. Show summary
8. Print next steps:
   echo "Restore complete! To use the restored VM:"
   echo "  open <dest>/<vm>.pvm"
   echo ""
   echo "To replace your current VM, manually move:"
   echo "  mv ~/Parallels/<vm>.pvm ~/Parallels/<vm>.pvm.old"
   echo "  mv <dest>/<vm>.pvm ~/Parallels/"
```

### 5. Status Command Logic

```
1. Run: rclone check ~/Parallels/<vm>.pvm azure-backup:parallels-vm/<vm>.pvm --one-way
2. Show differences (files only in local, only in remote, different)
3. Show local size: du -sh ~/Parallels/<vm>.pvm
4. Show remote size: rclone size azure-backup:parallels-vm/<vm>.pvm
```

### 6. List Command Logic

```
1. Run: rclone lsd azure-backup:parallels-vm/
2. Show available VM backups with sizes
```

## Error Handling

- Check rclone is installed → provide install command
- Check Azure CLI is installed → provide install command
- Check Azure login → provide az login command
- Check rclone connectivity to Azure blob before any operation
- Handle VM not found
- Handle backup in progress (lock file)
- Graceful Ctrl+C handling (resume VM if it was suspended)

## Output Format

- Progress bar for sync operations (rclone --progress)
- Summary at end: files synced, total size, duration
- Use colors: green=success, red=error, yellow=warning
- Always show helpful next-step commands on error

## Implementation Language

- Shell script (bash) - works on macOS zsh/bash
- Single file: `~/bin/backup_cli`

## File Structure

```
~/bin/
└── backup_cli                              # Main executable

~/.config/backup_cli/
├── config.yaml                             # User configuration
└── config.example.yaml                     # Documented example (generated by init)

~/.config/rclone/rclone.conf               # rclone config (standard location)
└── [azure-backup] section                  # Added by 'backup_cli init'
```

## Dependencies

| Dependency | Install Command | Required For |
|------------|-----------------|--------------|
| rclone | `brew install rclone` | File sync |
| Azure CLI | `brew install azure-cli` | Authentication |
| Parallels Desktop | (already installed) | VM management via prlctl |

## Quick Start (for end user)

```bash
# 1. Install dependencies
brew install rclone azure-cli

# 2. Login to Azure
az login

# 3. Initialize backup tool
backup_cli init

# 4. Backup your VM
backup_cli push

# 5. Check status
backup_cli status
```
