#!/usr/bin/env bash
set -euo pipefail

# sync_mac_ip - Auto-sync Ubuntu VM IP to Mac's SSH config and /etc/hosts
#
# This script automatically detects the Ubuntu VM's current IP address (which changes
# when you switch networks in bridge mode) and updates:
# - ~/.ssh/config (HostName for ubuntu)
# - /etc/hosts (myubuntu entry)
# - Flushes DNS cache to ensure new entries take effect immediately

# Configuration
VM_NAME="Ubuntu 24.04.3 ARM64"
SSH_CONFIG="$HOME/.ssh/config"
HOSTS_FILE="/etc/hosts"
SSH_HOST_ENTRY="ubuntu"
# NOTE: Avoid using .local hostnames – on macOS, *.local is reserved for mDNS/Bonjour
# and bypasses /etc/hosts. Also avoid real TLDs like .my (can conflict with registered domains).
# Using simple hostnames without TLD suffix (like 'myubuntu') ensures /etc/hosts is always checked first.
HOSTS_ENTRIES=("myubuntu")  # Hostnames to update in /etc/hosts
NETWORK_INTERFACE="enp0s5"  # Ubuntu VM network interface
PRLCTL="/usr/local/bin/prlctl"  # Full path to prlctl

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Utility functions
print_error() {
    echo -e "${RED}ERROR: $*${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$*${NC}"
}

print_warning() {
    echo -e "${YELLOW}WARNING: $*${NC}"
}

print_info() {
    echo -e "${BLUE}$*${NC}"
}

# Get VM IP address with auto-recovery
get_vm_ip() {
    local vm_ip
    local retry_count=0
    local max_retries=1

    # Check if VM is running
    if ! "$PRLCTL" list | grep -q "$VM_NAME"; then
        print_error "VM '$VM_NAME' is not running"
        exit 1
    fi

    while [[ $retry_count -le $max_retries ]]; do
        # Get IP from VM network interface (macOS grep doesn't support -P)
        vm_ip=$("$PRLCTL" exec "$VM_NAME" ip -4 addr show "$NETWORK_INTERFACE" 2>/dev/null | grep -o 'inet [0-9.]*' | awk '{print $2}' || true)

        if [[ -n "$vm_ip" ]]; then
            # Successfully got IP
            echo "$vm_ip"
            return 0
        fi

        # No IP detected
        if [[ $retry_count -eq 0 ]]; then
            # First attempt failed, try auto-recovery
            print_warning "VM is running but has no IPv4 address"
            print_info "Attempting auto-recovery: restarting NetworkManager in VM..."

            if "$PRLCTL" exec "$VM_NAME" sudo systemctl restart NetworkManager 2>/dev/null; then
                print_info "Waiting for network to recover..."
                sleep 6
                ((retry_count++))
            else
                print_error "Failed to restart NetworkManager"
                exit 1
            fi
        else
            # Retry failed
            print_error "Auto-recovery failed. VM still has no IPv4 address."
            print_info "This usually happens when:"
            print_info "  - You recently disconnected/reconnected to WiFi or hotspot"
            print_info "  - The VM's DHCP client isn't working properly"
            print_info ""
            print_info "Try manually: $PRLCTL exec \"$VM_NAME\" sudo systemctl restart NetworkManager"
            exit 1
        fi
    done
}

# Get current IP from SSH config
get_ssh_config_ip() {
    if [[ ! -f "$SSH_CONFIG" ]]; then
        echo ""
        return
    fi

    # Extract HostName from ubuntu section
    awk '
        /^Host ubuntu$/ { found=1; next }
        found && /^Host / { exit }
        found && /^  HostName / { print $2; exit }
    ' "$SSH_CONFIG"
}

# Get current IP from /etc/hosts for a specific hostname
get_hosts_ip() {
    local hostname="${1:-${HOSTS_ENTRIES[0]}}"
    if [[ ! -f "$HOSTS_FILE" ]]; then
        echo ""
        return
    fi

    # Extract IP for the hostname (only first match)
    grep -E "^[0-9.]+\s+$hostname" "$HOSTS_FILE" 2>/dev/null | awk 'NR==1 {print $1}' || echo ""
}

# Update SSH config
update_ssh_config() {
    local new_ip=$1
    local current_ip
    current_ip=$(get_ssh_config_ip)

    if [[ -z "$current_ip" ]]; then
        print_error "Could not find 'Host ubuntu' entry in $SSH_CONFIG"
        exit 1
    fi

    if [[ "$current_ip" == "$new_ip" ]]; then
        print_info "SSH config already up to date ($new_ip)"
        return 0
    fi

    print_info "Updating SSH config: $current_ip → $new_ip"

    # Create backup
    cp "$SSH_CONFIG" "$SSH_CONFIG.bak"

    # Update the IP using sed
    sed -i '' "/^Host ubuntu$/,/^Host / s/^  HostName .*/  HostName $new_ip/" "$SSH_CONFIG"

    # Remove old host key
    ssh-keygen -R "$current_ip" 2>/dev/null || true
    ssh-keygen -R "$SSH_HOST_ENTRY" 2>/dev/null || true

    print_success "✓ SSH config updated"
}

# Update /etc/hosts
update_hosts_file() {
    local new_ip=$1

    print_info "Updating /etc/hosts for VM hostnames..."

    # Create backup
    sudo cp "$HOSTS_FILE" "$HOSTS_FILE.bak"

    # Update each hostname
    for hostname in "${HOSTS_ENTRIES[@]}"; do
        local current_ip
        current_ip=$(get_hosts_ip "$hostname")

        # Remove ALL old entries for this hostname (in case of duplicates)
        sudo sed -i '' "/^[0-9.][0-9.]*[[:space:]][[:space:]]*${hostname}$/d" "$HOSTS_FILE"

        # Add new entry
        echo "$new_ip $hostname" | sudo tee -a "$HOSTS_FILE" >/dev/null

        if [[ -n "$current_ip" ]]; then
            print_info "  $hostname: $current_ip → $new_ip"
        else
            print_info "  $hostname: <none> → $new_ip"
        fi
    done

    print_success "✓ /etc/hosts updated"

    # Flush DNS cache on macOS to ensure new entries are used
    print_info "Flushing DNS cache..."
    sudo dscacheutil -flushcache 2>/dev/null || true
    sudo killall -HUP mDNSResponder 2>/dev/null || true
    print_success "✓ DNS cache flushed"
}

# Status command
cmd_status() {
    echo
    echo "=== Ubuntu VM IP Sync Status ==="
    echo

    # Get VM IP
    local vm_ip
    if ! vm_ip=$(get_vm_ip 2>&1); then
        print_error "Cannot get VM IP"
        echo "$vm_ip"
        exit 1
    fi

    print_info "VM Current IP: $vm_ip"
    echo

    # Check SSH config
    local ssh_ip
    ssh_ip=$(get_ssh_config_ip)

    if [[ -z "$ssh_ip" ]]; then
        print_warning "SSH config: No 'Host ubuntu' entry found"
    elif [[ "$ssh_ip" == "$vm_ip" ]]; then
        print_success "SSH config: ✓ In sync ($ssh_ip)"
    else
        print_warning "SSH config: ✗ Out of sync (configured: $ssh_ip, actual: $vm_ip)"
    fi

    # Check /etc/hosts for all hostnames
    local all_hosts_in_sync=true
    for hostname in "${HOSTS_ENTRIES[@]}"; do
        local hosts_ip
        hosts_ip=$(get_hosts_ip "$hostname")

        if [[ -z "$hosts_ip" ]]; then
            print_warning "/etc/hosts:  ✗ No entry for $hostname"
            all_hosts_in_sync=false
        elif [[ "$hosts_ip" == "$vm_ip" ]]; then
            print_success "/etc/hosts:  ✓ $hostname ($hosts_ip)"
        else
            print_warning "/etc/hosts:  ✗ $hostname out of sync (configured: $hosts_ip, actual: $vm_ip)"
            all_hosts_in_sync=false
        fi
    done

    echo

    # Overall status
    if [[ "$ssh_ip" == "$vm_ip" ]] && $all_hosts_in_sync; then
        print_success "Overall: ✓ All in sync"
        return 0
    else
        print_warning "Overall: ✗ Out of sync - run 'sync_mac_ip sync' to fix"
        return 1
    fi
}

# Sync command
cmd_sync() {
    echo
    print_info "=== Syncing Ubuntu VM IP ==="
    echo

    # Get VM IP
    local vm_ip
    vm_ip=$(get_vm_ip)

    print_info "Detected VM IP: $vm_ip"
    echo

    # Update SSH config (no sudo needed)
    update_ssh_config "$vm_ip"

    # Update /etc/hosts (will prompt for sudo password if needed)
    update_hosts_file "$vm_ip"

    echo
    print_success "=== Sync Complete ==="
    print_info "VM IP: $vm_ip"
    echo

    # Verify with ping test
    print_info "Verifying /etc/hosts is working..."
    for hostname in "${HOSTS_ENTRIES[@]}"; do
        if ping -c 1 -W 1 "$hostname" >/dev/null 2>&1; then
            local resolved_ip
            resolved_ip=$(ping -c 1 "$hostname" 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)
            if [[ "$resolved_ip" == "$vm_ip" ]]; then
                print_success "✓ $hostname resolves to $resolved_ip (correct)"
            else
                print_warning "⚠ $hostname resolves to $resolved_ip (expected $vm_ip)"
            fi
        else
            print_warning "✗ Cannot ping $hostname"
        fi
    done

    echo
    print_info "You can now SSH with: ssh ubuntu"
    print_info "Or use hostname: ssh parallels@myubuntu"
    echo
}

# Help command
cmd_help() {
    cat <<'EOF'
sync_mac_ip - Auto-sync Ubuntu VM IP to Mac's SSH config and /etc/hosts

USAGE:
    sync_mac_ip {status|sync|help}

COMMANDS:
    status      Check if VM IP is in sync with SSH config and /etc/hosts
    sync        Sync VM IP to ~/.ssh/config and /etc/hosts (will prompt for sudo password)
    help        Show this help message

DESCRIPTION:
    When using Ubuntu VM in bridge mode, the VM's IP address changes whenever
    you switch networks (home WiFi → phone hotspot → office WiFi, etc.).

    This script automatically detects the VM's current IP and updates:
    - ~/.ssh/config (HostName for 'ubuntu' entry)
    - /etc/hosts (myubuntu entry)

    This allows you to always use 'ssh ubuntu' or 'ssh parallels@myubuntu'
    regardless of which network you're connected to.

    Note: We use a simple hostname without TLD suffix to avoid conflicts with
    mDNS/Bonjour (.local) or real registered domains (.my, .dev, etc.).

AUTO-RECOVERY:
    If the VM is running but has no IPv4 address (common after network
    disconnect/reconnect), the script will automatically:
    - Restart NetworkManager in the VM
    - Wait for network to recover
    - Retry getting the IP address

    This handles cases like reconnecting to phone hotspot or WiFi.

WHEN TO USE:
    Run 'sync_mac_ip sync' whenever:
    - You switch networks (WiFi → hotspot, home → office, etc.)
    - SSH to VM fails with "Connection refused" or "No route to host"
    - After restarting the VM
    - After restarting NetworkManager in the VM

EXAMPLES:
    # Check if in sync
    sync_mac_ip status

    # Sync after switching networks
    sync_mac_ip sync

    # Then SSH normally
    ssh ubuntu

NETWORK SCENARIOS:
    Home WiFi:      VM gets 192.168.4.x    (from home router)
    Phone Hotspot:  VM gets 172.20.10.x    (from iPhone)
    Office WiFi:    VM gets 10.x.x.x       (from office router)

    After running 'sync_mac_ip sync', SSH always works regardless of network!

FILES MODIFIED:
    ~/.ssh/config       - Updates HostName for 'Host ubuntu' entry
    /etc/hosts          - Updates IP for 'myubuntu' entry

    Backups created:
    ~/.ssh/config.bak
    /etc/hosts.bak

    DNS cache flushed after updates to ensure immediate effect

REQUIREMENTS:
    - Ubuntu VM running in bridge network mode
    - Parallels Tools installed (prlctl command)
    - sudo access (for /etc/hosts updates)

EOF
}

# Main
main() {
    local cmd="${1:-}"

    case "$cmd" in
        status)
            cmd_status
            ;;
        sync)
            cmd_sync
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            print_error "Unknown command: ${cmd:-<none>}"
            echo
            echo "Usage: sync_mac_ip {status|sync|help}"
            echo
            exit 1
            ;;
    esac
}

main "$@"
